#!/usr/bin/env node

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const sourceDir = path.join(__dirname, 'source');
const outputFile = path.join(sourceDir, 'all.mimo');

function generateAllMimo() {
  try {
    // Read all files in the source directory
    const files = fs.readdirSync(sourceDir);
    
    // Filter for .mimo files, excluding all.mimo itself
    const mimoFiles = files
      .filter(file => file.endsWith('.mimo') && file !== 'all.mimo')
      .sort(); // Sort alphabetically for consistent output
    
    if (mimoFiles.length === 0) {
      console.log('No .mimo files found to import.');
      return;
    }
    
    // Generate the content for all.mimo
    let content = '// Auto-generated file that imports all test modules\n';
    content += '// Generated by test/generate-all-mimo.js\n';
    content += '// Do not edit manually - this file will be overwritten\n\n';
    content += 'show "=== All Test Modules ==="\n';
    
    // Add imports for each file
    mimoFiles.forEach(file => {
      const moduleName = path.basename(file, '.mimo');
      const namespace = moduleName.replace(/[-\s]/g, '_');
      content += `import ${namespace} from "${moduleName}"\n`;
    });
    
    content += '\nshow "All modules imported successfully!"\n';
    content += 'show "Available namespaces:"\n';
    
    // Add a list of all available namespaces
    mimoFiles.forEach(file => {
      const moduleName = path.basename(file, '.mimo');
      const namespace = moduleName.replace(/[-\s]/g, '_');
      content += `show "  - ${namespace} (from ${moduleName}.mimo)"\n`;
    });
    
    content += '\nshow "=== End All Test Modules ==="\n';
    
    // Write the file
    fs.writeFileSync(outputFile, content, 'utf8');
    
    console.log(`âœ… Generated ${outputFile}`);
    console.log(`ðŸ“¦ Imported ${mimoFiles.length} modules:`);
    mimoFiles.forEach(file => {
      const moduleName = path.basename(file, '.mimo');
      const namespace = moduleName.replace(/[-\s]/g, '_');
      console.log(`   ${namespace} <- ${file}`);
    });
    
  } catch (error) {
    console.error('âŒ Error generating all.mimo:', error.message);
    process.exit(1);
  }
}

// Run the generator if this script is executed directly
if (import.meta.url === `file://${process.argv[1]}`) {
  generateAllMimo();
}

export { generateAllMimo };
