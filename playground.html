<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mimo Playground - Interactive Programming Environment</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" id="highlight-theme">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --accent-primary: #3b82f6;
            --accent-hover: #2563eb;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            --border-color: #334155;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.3), 0 2px 4px -2px rgb(0 0 0 / 0.3);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.3), 0 4px 6px -4px rgb(0 0 0 / 0.3);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            background: var(--bg-secondary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        .header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-sm);
            z-index: 10;
            position: relative;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .logo-icon {
            width: 2rem;
            height: 2rem;
            background: linear-gradient(135deg, var(--accent-primary), #8b5cf6);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1rem;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn.loading {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .main-container {
            display: flex;
            height: calc(100vh - 4.5rem);
        }

        .sidebar {
            width: 300px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-title {
            margin: 0 0 0.5rem 0;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .examples-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .example-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .example-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-primary);
        }

        .example-title {
            font-weight: 500;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
        }

        .example-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .tabs {
            display: flex;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .tab.active {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
        }

        .tab:hover:not(.active) {
            color: var(--text-primary);
        }

        .split-pane {
            flex: 1;
            display: flex;
        }

        .code-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            position: relative;
        }

        .panel-header {
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .line-numbers {
            background: var(--bg-tertiary);
            color: var(--text-muted);
            padding: 1rem 0.5rem;
            min-width: 3rem;
            text-align: right;
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            font-size: 0.875rem;
            line-height: 1.5;
            user-select: none;
            border-right: 1px solid var(--border-color);
        }

        .code-input {
            flex: 1;
            padding: 1rem;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            font-size: 0.875rem;
            line-height: 1.5;
            resize: none;
            outline: none;
            white-space: pre;
            overflow-wrap: normal;
            overflow-x: auto;
        }

        .output-panel {
            flex: 1;
            background: var(--bg-primary);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .output-content {
            flex: 1;
            padding: 1rem;
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            font-size: 0.875rem;
            line-height: 1.5;
            white-space: pre-wrap;
            overflow-y: auto;
            color: var(--text-primary);
        }

        .output-empty {
            color: var(--text-muted);
            font-style: italic;
            text-align: center;
            padding: 2rem;
        }

        .output-success {
            color: var(--success);
        }

        .output-error {
            color: var(--error);
            background: rgba(239, 68, 68, 0.1);
            padding: 0.75rem;
            border-radius: var(--radius-md);
            border-left: 4px solid var(--error);
            margin: 0.5rem 0;
        }

        .theme-toggle {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            background: var(--bg-tertiary);
        }

        .spinner {
            width: 1rem;
            height: 1rem;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .status-bar {
            background: var(--bg-tertiary);
            padding: 0.5rem 1rem;
            border-top: 1px solid var(--border-color);
            font-size: 0.75rem;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .split-pane {
                flex-direction: column;
            }
            
            .output-panel {
                border-left: none;
                border-top: 1px solid var(--border-color);
            }
        }

        /* Highlight.js overrides for dark theme */
        [data-theme="dark"] .hljs {
            background: var(--bg-primary) !important;
            color: var(--text-primary) !important;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon">M</div>
            <h1>Mimo Playground</h1>
        </div>
        <div class="header-controls">
            <button id="run-button" class="btn">
                <span id="run-icon">‚ñ∂</span>
                <span id="run-text">Run Code</span>
            </button>
            <button id="clear-button" class="btn btn-secondary">Clear</button>
            <button id="theme-toggle" class="theme-toggle" title="Toggle theme">
                <span id="theme-icon">üåô</span>
            </button>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h3 class="sidebar-title">Examples</h3>
            </div>
            <div class="examples-list" id="examples-list">
                <div class="example-item" data-example="hello">
                    <div class="example-title">Hello World</div>
                    <div class="example-desc">Basic output and variables</div>
                </div>
                <div class="example-item" data-example="functions">
                    <div class="example-title">Functions</div>
                    <div class="example-desc">Function definitions and calls</div>
                </div>
                <div class="example-item" data-example="arrays">
                    <div class="example-title">Arrays</div>
                    <div class="example-desc">Array operations and manipulation</div>
                </div>
                <div class="example-item" data-example="control">
                    <div class="example-title">Control Flow</div>
                    <div class="example-desc">Conditions and loops</div>
                </div>
                <div class="example-item" data-example="math">
                    <div class="example-title">Mathematics</div>
                    <div class="example-desc">Mathematical operations</div>
                </div>
                <div class="example-item" data-example="strings">
                    <div class="example-title">String Operations</div>
                    <div class="example-desc">String manipulation and formatting</div>
                </div>
            </div>
        </aside>

        <!-- Editor Container -->
        <main class="editor-container">
            <div class="tabs">
                <button class="tab active" data-tab="code">Code</button>
                <button class="tab" data-tab="docs">Documentation</button>
            </div>

            <div class="split-pane">
                <!-- Code Panel -->
                <div class="code-panel">
                    <div class="panel-header">
                        <span>main.mimo</span>
                        <span id="char-count">0 characters</span>
                    </div>
                    <div style="display: flex; flex: 1;">
                        <div class="line-numbers" id="line-numbers">1</div>
                        <textarea id="code-input" class="code-input" placeholder="Enter your Mimo code here..." spellcheck="false">show "Hello from the Mimo Playground!"

const GREETING "Welcome to Mimo"

function greet(name)
    return + + GREETING ", " name "!"
end

call greet("Developer") -> message
show message

set my_arr [10, 20, 30, 40, 50]
show + "Array: " + call str(my_arr)
show + "Third element: " + call get(my_arr, 2)

// Mathematical operations
set x 15
set y 7
show + "x + y = " + call str(+ x y)
show + "x * y = " + call str(* x y)

// String operations
set text "Programming"
show + "Length: " + call str(call len(text))
show + "Uppercase: " + call upper(text)</textarea>
                    </div>
                </div>

                <!-- Output Panel -->
                <div class="output-panel">
                    <div class="panel-header">
                        <span>Output</span>
                        <span id="execution-time"></span>
                    </div>
                    <div id="output-content" class="output-content">
                        <div class="output-empty">Click "Run Code" to see the output...</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <span id="status-text">Ready</span>
        <span id="cursor-position">Line 1, Column 1</span>
    </div>

    <!-- Include the bundled Mimo interpreter -->
    <script src="./dist/mimo.web.js"></script>
    
    <!-- Enhanced playground logic -->
    <script>
        // DOM elements
        const codeInput = document.getElementById('code-input');
        const outputContent = document.getElementById('output-content');
        const runButton = document.getElementById('run-button');
        const clearButton = document.getElementById('clear-button');
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const runIcon = document.getElementById('run-icon');
        const runText = document.getElementById('run-text');
        const lineNumbers = document.getElementById('line-numbers');
        const charCount = document.getElementById('char-count');
        const statusText = document.getElementById('status-text');
        const cursorPosition = document.getElementById('cursor-position');
        const executionTime = document.getElementById('execution-time');
        const examplesList = document.getElementById('examples-list');

        // Example code snippets
        const examples = {
            hello: `show "Hello from the Mimo Playground!"

const GREETING "Welcome to Mimo"
show + GREETING ", Developer!"

set name "World"
show + "Hello, " name`,

            functions: `// Function definitions and calls
function add(a, b)
    return + a b
end

function multiply(x, y)
    return * x y
end

function greet(name)
    return + "Hello, " + name "!"
end

// Function calls
call add(5, 3) -> sum
show + "5 + 3 = " + call str(sum)

call multiply(4, 7) -> product
show + "4 * 7 = " + call str(product)

call greet("Mimo User") -> greeting
show greeting`,

            arrays: `// Array operations
set numbers [1, 2, 3, 4, 5]
show + "Original array: " + call str(numbers)

// Getting elements
call get(numbers, 0) -> first
call get(numbers, -1) -> last
show + "First: " + call str(first)
show + "Last: " + call str(last)

// Array length
call len(numbers) -> length
show + "Length: " + call str(length)

// Adding elements
call push(numbers, 6) -> new_array
show + "After push: " + call str(new_array)

// Slicing
call slice(numbers, 1, 3) -> sub_array
show + "Slice [1:3]: " + call str(sub_array)`,

            control: `// Control flow examples
set x 10

// Conditional statements
if > x 5
    show "x is greater than 5"
else
    show "x is not greater than 5"
end

// Loops
set i 0
while < i 5
    show + "Count: " + call str(i)
    set i + i 1
end

// Pattern matching
set value 42
match value
    case 10
        show "It's ten"
    case 42
        show "The answer to everything!"
    default
        show "Something else"
end`,

            math: `// Mathematical operations
set a 15
set b 7

show + "a = " + call str(a)
show + "b = " + call str(b)
show "---"

show + "Addition: " + call str(+ a b)
show + "Subtraction: " + call str(- a b)
show + "Multiplication: " + call str(* a b)
show + "Division: " + call str(/ a b)
show + "Modulo: " + call str(% a b)

// Math functions
show + "Square root of 16: " + call str(call sqrt(16))
show + "Power (2^3): " + call str(call pow(2, 3))
show + "Absolute value of -5: " + call str(call abs(-5))

// Random numbers
call random() -> rand_num
show + "Random number: " + call str(rand_num)`,

            strings: `// String operations
set text "Hello, Mimo!"
show + "Original: " + text

// String functions
call len(text) -> length
show + "Length: " + call str(length)

call upper(text) -> upper_text
show + "Uppercase: " + upper_text

call lower(text) -> lower_text
show + "Lowercase: " + lower_text

// String slicing
call slice(text, 0, 5) -> hello
show + "First 5 chars: " + hello

call slice(text, 7, -1) -> mimo
show + "Last part: " + mimo

// String concatenation
set first "Hello"
set second "World"
set combined + + first ", " second
show + "Combined: " + combined`
        };

        // Theme management
        let isDarkTheme = localStorage.getItem('mimo-theme') === 'dark';
        
        function updateTheme() {
            if (isDarkTheme) {
                document.documentElement.setAttribute('data-theme', 'dark');
                themeIcon.textContent = '‚òÄÔ∏è';
                document.getElementById('highlight-theme').href = 
                    'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css';
            } else {
                document.documentElement.removeAttribute('data-theme');
                themeIcon.textContent = 'üåô';
                document.getElementById('highlight-theme').href = 
                    'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css';
            }
            localStorage.setItem('mimo-theme', isDarkTheme ? 'dark' : 'light');
        }

        // Initialize theme
        updateTheme();

        // Line numbers update
        function updateLineNumbers() {
            const lines = codeInput.value.split('\n').length;
            const numbers = Array.from({length: lines}, (_, i) => i + 1).join('\n');
            lineNumbers.textContent = numbers;
        }

        // Character count update
        function updateCharCount() {
            const count = codeInput.value.length;
            charCount.textContent = `${count} characters`;
        }

        // Cursor position update
        function updateCursorPosition() {
            const text = codeInput.value;
            const pos = codeInput.selectionStart;
            const lines = text.substring(0, pos).split('\n');
            const line = lines.length;
            const col = lines[lines.length - 1].length + 1;
            cursorPosition.textContent = `Line ${line}, Column ${col}`;
        }

        // Console capture for output
        const originalLog = console.log;
        const originalError = console.error;
        let outputBuffer = [];
        
        function captureConsole() {
            outputBuffer = [];
            console.log = (...args) => {
                outputBuffer.push({type: 'log', content: args.join(' ')});
            };
            console.error = (...args) => {
                outputBuffer.push({type: 'error', content: args.join(' ')});
            };
        }

        function restoreConsole() {
            console.log = originalLog;
            console.error = originalError;
        }

        // Format output
        function formatOutput(buffer, executionTimeMs) {
            if (buffer.length === 0) {
                return '<div class="output-empty">No output generated.</div>';
            }

            let html = '';
            buffer.forEach(item => {
                const className = item.type === 'error' ? 'output-error' : 'output-success';
                html += `<div class="${className}">${escapeHtml(item.content)}</div>`;
            });
            
            if (executionTimeMs !== undefined) {
                html += `<div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); color: var(--text-muted); font-size: 0.75rem;">
                    Execution completed in ${executionTimeMs}ms
                </div>`;
            }
            
            return html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Run code
        async function runCode() {
            const sourceCode = codeInput.value.trim();
            if (!sourceCode) {
                outputContent.innerHTML = '<div class="output-empty">Please enter some code to run.</div>';
                return;
            }

            // Update UI for running state
            runButton.classList.add('loading');
            runIcon.innerHTML = '<div class="spinner"></div>';
            runText.textContent = 'Running...';
            statusText.textContent = 'Executing code...';
            outputContent.innerHTML = '<div class="output-empty">Executing...</div>';

            try {
                captureConsole();
                const startTime = performance.now();
                
                // Run the Mimo code
                const mimo = new window.Mimo(window.mimoBrowserAdapter);
                const result = mimo.run(sourceCode, '/playground.mimo');
                
                const endTime = performance.now();
                const executionTime = Math.round(endTime - startTime);
                
                // Add result to output if it's not null/undefined
                if (result !== null && result !== undefined) {
                    outputBuffer.push({
                        type: 'log', 
                        content: `‚Üí ${JSON.stringify(result)}`
                    });
                }

                outputContent.innerHTML = formatOutput(outputBuffer, executionTime);
                executionTime.textContent = `${executionTime}ms`;
                statusText.textContent = 'Execution completed';

            } catch (error) {
                const errorMessage = error.toString();
                outputContent.innerHTML = `<div class="output-error">‚ùå Error:\n${escapeHtml(errorMessage)}</div>`;
                statusText.textContent = 'Execution failed';
                executionTime.textContent = '';
            } finally {
                restoreConsole();
                
                // Reset button state
                runButton.classList.remove('loading');
                runIcon.textContent = '‚ñ∂';
                runText.textContent = 'Run Code';
            }
        }

        // Clear output
        function clearOutput() {
            outputContent.innerHTML = '<div class="output-empty">Output cleared.</div>';
            executionTime.textContent = '';
            statusText.textContent = 'Ready';
        }

        // Load example
        function loadExample(exampleKey) {
            if (examples[exampleKey]) {
                codeInput.value = examples[exampleKey];
                updateLineNumbers();
                updateCharCount();
                updateCursorPosition();
                clearOutput();
                statusText.textContent = `Loaded example: ${exampleKey}`;
            }
        }

        // Event listeners
        runButton.addEventListener('click', runCode);
        clearButton.addEventListener('click', clearOutput);
        
        themeToggle.addEventListener('click', () => {
            isDarkTheme = !isDarkTheme;
            updateTheme();
        });

        codeInput.addEventListener('input', () => {
            updateLineNumbers();
            updateCharCount();
        });

        codeInput.addEventListener('keyup', updateCursorPosition);
        codeInput.addEventListener('click', updateCursorPosition);

        // Handle example clicks
        examplesList.addEventListener('click', (e) => {
            const exampleItem = e.target.closest('.example-item');
            if (exampleItem) {
                const exampleKey = exampleItem.dataset.example;
                loadExample(exampleKey);
                
                // Visual feedback
                document.querySelectorAll('.example-item').forEach(item => {
                    item.style.background = '';
                });
                exampleItem.style.background = 'var(--accent-primary)';
                exampleItem.style.color = 'white';
                setTimeout(() => {
                    exampleItem.style.background = '';
                    exampleItem.style.color = '';
                }, 200);
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                runCode();
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                clearOutput();
            }
        });

        // Tab handling in textarea
        codeInput.addEventListener('keydown', (e) => {
            if (e.key === 'Tab') {
                e.preventDefault();
                const start = codeInput.selectionStart;
                const end = codeInput.selectionEnd;
                codeInput.value = codeInput.value.substring(0, start) + '    ' + codeInput.value.substring(end);
                codeInput.selectionStart = codeInput.selectionEnd = start + 4;
                updateLineNumbers();
                updateCharCount();
            }
        });

        // Initialize
        updateLineNumbers();
        updateCharCount();
        updateCursorPosition();
        statusText.textContent = 'Ready - Press Ctrl+Enter to run code';

    </script>
</body>
</html>