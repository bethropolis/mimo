name: Deploy Docs

on:
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - '.github/workflows/docs.yml'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Create docsify structure
        run: |
          cd docs
          
          # Create index.html for docsify
          cat > index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <title>Mimo Documentation</title>
            <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
            <meta name="description" content="A minimal prefix-notation programming language">
            <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
            <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/docsify@4/lib/themes/vue.css">
            <style>
              :root {
                --theme-color: #a855f7;
                --theme-color-dark: #7c3aed;
              }
            </style>
          </head>
          <body>
            <div id="app"></div>
            <script>
              window.$docsify = {
                name: 'Mimo',
                repo: 'https://github.com/bethropolis/mimo',
                loadSidebar: '_sidebar.md',
                relativePath: true,
                auto2top: true,
                subMaxLevel: 3,
                search: 'auto'
              }
            </script>
            <script src="//cdn.jsdelivr.net/npm/docsify@4"></script>
            <script src="//cdn.jsdelivr.net/npm/docsify/lib/plugins/search.min.js"></script>
          </body>
          </html>
          EOF
          
          # Create sidebar
          cat > _sidebar.md << 'EOF'
          * Getting Started
            * [Overview](README.md)
            * [Syntax Guide](syntax-guide.md)
            * [Testing](testing.md)
          * Language Reference
            * [Variables](syntax/variables.md)
            * [Data Types](syntax/data-types.md)
            * [Operators](syntax/operators.md)
            * [Control Flow](syntax/control-flow.md)
            * [Functions](syntax/functions.md)
            * [Collections](syntax/collections.md)
            * [Pattern Matching](syntax/pattern-matching.md)
            * [Modules](syntax/modules.md)
            * [Error Handling](syntax/error-handling.md)
            * [Standard Library](syntax/stdlib.md)
          * Advanced
            * [Destructuring](syntax/destructuring.md)
            * [Template Literals](syntax/template-literals.md)
            * [Array Operations](syntax/array-operations.md)
            * [Style Guide](syntax/style-guide.md)
          * Examples
            * [Inventory](examples/inventory/app.mimo)
            * [Quiz](examples/quiz/main.mimo)
            * [Task Manager](examples/task-manager/main.mimo)
          EOF

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
